<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>CodeMirror Backslash Bug with LaTeX Mode</title>
  <style>
    body { 
      font-family: system-ui, sans-serif; 
      padding: 20px; 
      max-width: 1000px; 
      margin: 0 auto;
    }
    .editor-container { 
      border: 1px solid #ddd; 
      margin: 20px 0; 
    }
    .info { 
      padding: 15px; 
      background: #f5f5f5; 
      border: 1px solid #ccc; 
      margin: 10px 0; 
      font-family: monospace;
      font-size: 14px;
    }
    .pass { color: green; font-weight: bold; }
    .fail { color: red; font-weight: bold; }
    h2 { margin-top: 30px; }
  </style>
</head>
<body>
  <h1>CodeMirror 6 Backslash Bug Reproduction</h1>
  
  <h2>Test 1: Basic CodeMirror (No Bug Expected)</h2>
  <div id="editor1" class="editor-container"></div>
  <div id="info1" class="info"></div>

  <h2>Test 2: With LaTeX Language Mode (Bug Expected)</h2>
  <div id="editor2" class="editor-container"></div>
  <div id="info2" class="info"></div>

  <script type="module">
    import { EditorView, basicSetup } from 'https://cdn.jsdelivr.net/npm/codemirror@6.0.1/dist/index.js';
    import { latex } from 'https://cdn.jsdelivr.net/npm/codemirror-lang-latex@0.2.0/dist/index.js';
    
    const testContent = "a\\\\b"; // 2 backslashes
    
    // Helper function
    function countBackslashes(str) {
      return (str.match(/\\/g) || []).length;
    }
    
    function analyzeEditor(view, infoId, testName) {
      const getValue = view.state.doc.toString();
      const domText = document.querySelector(`#${infoId.replace('info', 'editor')} .cm-content`)?.textContent || '';
      
      const getValueCount = countBackslashes(getValue);
      const domCount = countBackslashes(domText);
      const hasBug = getValueCount !== domCount;
      
      document.getElementById(infoId).innerHTML = `
        <strong>${testName}</strong><br>
        Input: "a\\\\\\\\b" (2 backslashes in JS string)<br>
        <br>
        view.state.doc.toString(): "${getValue}" (${getValueCount} backslashes)<br>
        DOM .textContent: "${domText}" (${domCount} backslashes)<br>
        <br>
        Character codes: [${Array.from(domText).map(c => c.charCodeAt(0)).join(', ')}]<br>
        <br>
        <span class="${hasBug ? 'fail' : 'pass'}">
          ${hasBug ? '✗ BUG: Counts differ!' : '✓ No bug: Counts match'}
        </span>
      `;
    }
    
    // Test 1: Basic CodeMirror
    const view1 = new EditorView({
      doc: testContent,
      extensions: [basicSetup],
      parent: document.getElementById('editor1')
    });
    
    setTimeout(() => analyzeEditor(view1, 'info1', 'Basic CodeMirror'), 100);
    
    // Test 2: With LaTeX mode
    const view2 = new EditorView({
      doc: testContent,
      extensions: [
        basicSetup,
        latex()
      ],
      parent: document.getElementById('editor2')
    });
    
    setTimeout(() => analyzeEditor(view2, 'info2', 'With LaTeX Language Mode'), 100);
  </script>
</body>
</html>
